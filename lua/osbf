
-- simple command-line client



require 'osbf'
require 'osbf.command_line'
require 'osbf.options'
require 'osbf.util'

osbf.util.progname = arg[0] or 'osbf'

local function die(...)
  io.stderr:write(...)
  os.exit(1)
end

osbf.options.register { long = 'trace', usage = ' # stack trace on error',
                   help = [[
  --trace
      Don't recover from errors; give a stack trace instead
]] }

local ok, options, args = pcall(osbf.options.parse, arg)
if not ok then
  die(arg[0], ': ', options, '\n')
end

if options.trace then
  osbf.command_line.pcall = function(f, ...) return true, f(...) end
end

local pcall = osbf.command_line.pcall

local ok, msg = pcall(osbf.init, options, args[1] == 'init')
if not ok then
  die(arg[0], ' failed during initialization: ', msg, '\n')
end

osbf.command_line.run(unpack(args))
osbf.util.close_mime_multipart()
