
-- simple command-line client



require 'osbf'
require 'osbf.command_line'
require 'osbf.options'
require 'osbf.util'
require 'osbf.output'

osbf.util.progname = arg[0] or 'osbf'

local function die(...)
  io.stderr:write(...)
  os.exit(1)
end

osbf.options.register { long = 'trace', usage = ' # stack trace on error',
                   help = [[
  --trace
      Don't recover from errors; give a stack trace instead
]] }

osbf.options.register { long = 'profile', usage = ' # profile to osbf.lprof',
                   help = [[
  --profile
      Write a LuaProfiler profile to lprof.out
]] }

local ok, options, args = pcall(osbf.options.parse, arg)
if not ok then
  die(arg[0], ': ', options, '\n')
end

if options.profile then
  require 'profiler'
  profiler.start 'osbf.lprof'
end

if options.trace then
  osbf.command_line.pcall = function(f, ...) return true, f(...) end
  pcall =     osbf.command_line.pcall 
end

local pcall = osbf.command_line.pcall

local ok, msg = pcall(osbf.init, options, args[1] == 'init')
if not ok then
  die(arg[0], ' failed during initialization: ', msg, '\n')
end

osbf.command_line.run(unpack(args))
if options.profile then
  profiler.stop()
end
osbf.output.exit(0)

